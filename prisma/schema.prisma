// Prisma Schema for Education App
// Database: MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// USER & AUTHENTICATION
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          String    @default("STUDENT")
  avatar        String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  teacherClasses    Classroom[]       @relation("TeacherClasses")
  studentClasses    ClassEnrollment[]
  createdAssignments Assignment[]     @relation("CreatedAssignments")
  submissions       Submission[]
  feedbacks         Feedback[]        @relation("TeacherFeedbacks")

  @@map("users")
}

// CLASSROOM SYSTEM
model Classroom {
  id          String   @id @default(cuid())
  name        String
  description String?
  subject     String?
  code        String   @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacherId   String
  teacher     User              @relation("TeacherClasses", fields: [teacherId], references: [id])
  enrollments ClassEnrollment[]
  assignments Assignment[]

  @@map("classrooms")
}

model ClassEnrollment {
  id        String   @id @default(cuid())
  joinedAt  DateTime @default(now())
  isActive  Boolean  @default(true)

  studentId   String
  student     User      @relation(fields: [studentId], references: [id])
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id])

  @@unique([studentId, classroomId])
  @@map("class_enrollments")
}

// ASSIGNMENT SYSTEM
model Assignment {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String
  status      String   @default("DRAFT")
  deadline    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  classroomId String
  classroom   Classroom    @relation(fields: [classroomId], references: [id])
  createdById String
  createdBy   User         @relation("CreatedAssignments", fields: [createdById], references: [id])

  questions   Question[]
  submissions Submission[]
  attachments AssignmentAttachment[]

  @@map("assignments")
}

model AssignmentAttachment {
  id           String   @id @default(cuid())
  fileName     String
  fileUrl      String
  fileType     String
  createdAt    DateTime @default(now())

  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@map("assignment_attachments")
}

// QUESTION SYSTEM
model Question {
  id           String   @id @default(cuid())
  content      String
  audioUrl     String?
  imageUrl     String?
  orderIndex   Int      @default(0)
  correctText  String?
  sampleAudio  String?
  createdAt    DateTime @default(now())

  options      QuestionOption[]
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  answers      Answer[]

  @@map("questions")
}

model QuestionOption {
  id         String  @id @default(cuid())
  content    String
  isCorrect  Boolean @default(false)
  orderIndex Int     @default(0)

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

// SUBMISSION SYSTEM
model Submission {
  id          String    @id @default(cuid())
  status      String    @default("IN_PROGRESS")
  score       Float?
  maxScore    Float?
  submittedAt DateTime?
  gradedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  studentId    String
  student      User       @relation(fields: [studentId], references: [id])
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])

  answers      Answer[]
  feedback     Feedback?
  attachments  SubmissionAttachment[]

  @@unique([studentId, assignmentId])
  @@map("submissions")
}

model SubmissionAttachment {
  id           String   @id @default(cuid())
  fileName     String
  fileUrl      String
  fileType     String
  createdAt    DateTime @default(now())

  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("submission_attachments")
}

// ANSWER SYSTEM
model Answer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  selectedOptionIds String   @default("[]")
  textContent String?
  audioUrl       String?
  transcript     String?
  accuracyScore  Float?
  aiAnalysis     String?
  documentLabels String?
  score    Float?
  maxScore Float?

  questionId   String
  question     Question   @relation(fields: [questionId], references: [id])
  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([questionId, submissionId])
  @@map("answers")
}

// FEEDBACK SYSTEM
model Feedback {
  id          String   @id @default(cuid())
  comment     String?
  audioUrl    String?
  annotations String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacherId    String
  teacher      User       @relation("TeacherFeedbacks", fields: [teacherId], references: [id])
  submissionId String     @unique
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("feedbacks")
}
